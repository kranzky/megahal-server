#!/usr/bin/env rails runner

redis = Redis.new(url: ENV.fetch("REDIS_URL") { "redis://localhost:6379/1" })

modified = false
last_modified = DateTime.now.utc

# load the brain

while true
  redis.scan_each(match: "megahal-message:*").each do |key|
    # suppress exceptions
    data = JSON.parse(redis.getdel(key), symbolize_names: true)
    received = Time.now.utc
    sent = Time.at(data[:time].to_f).utc
    name = data[:name]
    message = data[:message]
    response = "Why you say #{message}?"
    key.gsub!("-message:", "-reply:")
    redis.set(key, response)
    if (last_modified.to_date.mjd != sent.to_date.mjd)
      # copy "log.txt" to "log_#{last_modified.to_date}.txt"
      # delete "log.txt"
    end
    # append to "log.txt"
    puts "#{sent.iso8601}:#{name}|#{message}"
    puts "#{received.iso8601}:MegaHAL|#{response}"
    modified = true
    last_modified = received.to_datetime
  end
  elapsed = DateTime.now.utc - last_modified
  if modified && elapsed > 30
    # save the brain
    puts "SAVE"
    modified = false
  else
    sleep 0.1
  end
end
